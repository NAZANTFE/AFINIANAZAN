<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil · AfinIA</title>
  <link rel="stylesheet" href="estilos-perfil.css"/>
</head>
<body>
  <div class="contenedor">
    <!-- Logo -->
    <div class="logo-contenedor">
      <img src="logo_afinia.png" alt="Logo AfinIA" class="logo-afinia" />
    </div>

    <!-- (Opcional) buscador y botón + -->
    <header class="barra-superior">
      <input type="text" placeholder="Buscar usuarios..." class="buscador"/>
      <button class="boton-plus">+</button>
    </header>

    <!-- Perfil -->
    <section class="perfil">
      <!-- Foto (si usas borde dinámico, deja este contenedor) -->
      <div class="foto-wrapper">
        <img src="foto_perfil.jpg" alt="Foto de perfil" class="foto-perfil" id="fotoPerfil" />
      </div>

      <div class="info-perfil">
        <h2>JJ Martín</h2>
        <p class="handle">@jjmartin</p>
        <p class="rol">CEO y Desarrollador</p>

        <!-- Parámetros -->
        <div class="parametros" id="listaParametros"></div>

        <!-- Botones -->
        <div class="botones-dobles">
          <a href="afinar.html" class="boton-afinar">Afinar</a>
          <button class="editar">Editar perfil</button>
        </div>
      </div>

      <!-- Galería privada -->
      <div class="galeria-privada">
        <label class="foto-extra">
          <input type="file" accept="image/*" class="input-foto" onchange="cargarFoto(this)">
          <img src="silueta.png" alt="Foto 1" />
        </label>
        <label class="foto-extra">
          <input type="file" accept="image/*" class="input-foto" onchange="cargarFoto(this)">
          <img src="silueta.png" alt="Foto 2" />
        </label>
        <label class="foto-extra">
          <input type="file" accept="image/*" class="input-foto" onchange="cargarFoto(this)">
          <img src="silueta.png" alt="Foto 3" />
        </label>
        <label class="foto-extra">
          <input type="file" accept="image/*" class="input-foto" onchange="cargarFoto(this)">
          <img src="silueta.png" alt="Foto 4" />
        </label>
      </div>
    </section>
  </div>

  <script>
  // ===== Backend: local en dev, Railway en producción =====
  const API_BASE = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
    ? "http://localhost:3000"
    : "https://afinianazan-production-99ce.up.railway.app"; // <- TU Railway (HTTPS)

  const COLORES = {
    "Inteligencia": "verde",
    "Simpatía": "rojo",
    "Comunicación": "azul",
    "Carisma": "dorado",
    "Creatividad": "lavanda",
    "Resolución de conflictos": "coral",
    "Iniciativa": "oliva",
    "Organización": "lila",
    "Impulso personal": "amarillo"
  };

  async function cargarParametros() {
    try {
      const res = await fetch(`${API_BASE}/parametros`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const datos = await res.json();

      const sinNivel = Object.entries(datos).filter(([k]) => k !== "Nivel AfinIA");
      const top4 = sinNivel.sort((a,b) => b[1]-a[1]).slice(0,4);

      const lista = document.getElementById('listaParametros');
      lista.innerHTML = "";

      top4.forEach(([nombre, valor]) => {
        const clase = COLORES[nombre] || "gris";
        const item = document.createElement('div');
        item.className = "parametro";
        item.innerHTML = `
          <div class="nombre-parametro">${nombre}</div>
          <div class="barra-base">
            <div class="barra ${clase}" style="width:${valor}%"></div>
            <span class="porcentaje">${valor}%</span>
          </div>
        `;
        lista.appendChild(item);
      });
    } catch (e) {
      console.error("No pude cargar /parametros:", e);
      // Muestra algo por defecto para no dejar vacío
      document.getElementById('listaParametros').innerHTML = `
        <div class="parametro"><div class="nombre-parametro">Inteligencia</div>
          <div class="barra-base"><div class="barra verde" style="width:10%"></div><span class="porcentaje">10%</span></div>
        </div>
        <div class="parametro"><div class="nombre-parametro">Simpatía</div>
          <div class="barra-base"><div class="barra rojo" style="width:10%"></div><span class="porcentaje">10%</span></div>
        </div>
        <div class="parametro"><div class="nombre-parametro">Comunicación</div>
          <div class="barra-base"><div class="barra azul" style="width:10%"></div><span class="porcentaje">10%</span></div>
        </div>
        <div class="parametro"><div class="nombre-parametro">Carisma</div>
          <div class="barra-base"><div class="barra dorado" style="width:10%"></div><span class="porcentaje">10%</span></div>
        </div>`;
    }
  }

  // Galería (igual que ya tenías)
  const claveFotos = "fotosPerfil";
  function cargarFoto(input){
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        const img = input.parentElement.querySelector('img');
        img.src = e.target.result;
        img.style.opacity = 1;
        const fotos = Array.from(document.querySelectorAll('.galeria-privada label img')).map(i => i.src);
        localStorage.setItem(claveFotos, JSON.stringify(fotos));
      };
      reader.readAsDataURL(input.files[0]);
    }
  }
  function cargarFotosGuardadas(){
    try{
      const guardadas = JSON.parse(localStorage.getItem(claveFotos));
      if (!guardadas) return;
      const imgs = document.querySelectorAll('.galeria-privada label img');
      guardadas.forEach((src,i)=>{ if(imgs[i]){ imgs[i].src = src; imgs[i].style.opacity = 1; }});
    }catch{}
  }

  document.addEventListener("DOMContentLoaded", () => {
    cargarParametros();
    cargarFotosGuardadas();
  });
</script>

</body>
</html>
