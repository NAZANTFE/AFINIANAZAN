<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil AfinIA</title>
  <link rel="stylesheet" href="estilos-perfil.css"/>
</head>
<body>
  <div class="contenedor">
    <div class="logo-contenedor">
      <img src="logo_afinia.png" alt="Logo AfinIA" class="logo-afinia" />
    </div>

    <header>
      <input type="text" placeholder="Buscar usuarios..." class="buscador"/>
      <button class="boton-plus">+</button>
    </header>

    <section class="perfil">
      <div class="foto-perfil-progreso" id="borde-progreso">
        <img src="foto_perfil.jpg" alt="Foto de perfil" class="foto-perfil" id="fotoPerfil" />
      </div>

      <div class="info-perfil">
        <h2 id="nombreUsuario">JJ Mart칤n</h2>
        <p id="usuarioArroba">@jjmartin</p>
        <p class="rol" id="rolUsuario">CEO y Desarrollador</p>

        <div class="parametros"></div>

        <div class="botones-dobles">
          <a id="linkAfinar" href="afinar.html" class="boton-afinar">Afinar</a>
          <button class="editar">Editar perfil</button>
        </div>
      </div>

      <!-- GALER칈A -->
      <div class="galeria-privada">
        <label class="foto-extra">
          <input type="file" accept="image/*" class="input-foto" onchange="cargarFoto(this)">
          <img src="silueta.png" alt="Foto 1" />
        </label>
        <label class="foto-extra">
          <input type="file" accept="image/*" class="input-foto" onchange="cargarFoto(this)">
          <img src="silueta.png" alt="Foto 2" />
        </label>
        <label class="foto-extra">
          <input type="file" accept="image/*" class="input-foto" onchange="cargarFoto(this)">
          <img src="silueta.png" alt="Foto 3" />
        </label>
        <label class="foto-extra">
          <input type="file" accept="image/*" class="input-foto" onchange="cargarFoto(this)">
          <img src="silueta.png" alt="Foto 4" />
        </label>
      </div>
    </section>
  </div>

  <script>
    // ====== Auto-detecci칩n backend ======
    const API_BASE = (() => {
      const h = location.hostname;
      if (h === "localhost" || h === "127.0.0.1") return "http://localhost:3000";
      return "https://afinianazan-production-99ce.up.railway.app";
    })();

    // ====== userId (desde ?u= o localStorage) ======
    function sanitizeId(id){ return (id||"").toLowerCase().trim().replace(/[^a-z0-9_-]/g,""); }
    const params = new URLSearchParams(location.search);
    let USER_ID = params.get("u") || localStorage.getItem("afinia_user_id") || "default";
    USER_ID = sanitizeId(USER_ID) || "default";
    localStorage.setItem("afinia_user_id", USER_ID);

    // Mant칠n el userId cuando entras a afinar
    const linkAfinar = document.getElementById("linkAfinar");
    linkAfinar.href = `afinar.html?u=${encodeURIComponent(USER_ID)}`;

    const fotoPerfil = document.getElementById("fotoPerfil");
    const nombreUsuario = document.getElementById("nombreUsuario");
    const usuarioArroba = document.getElementById("usuarioArroba");
    const rolUsuario = document.getElementById("rolUsuario");

    // ---- Perfiles de prueba ----
    function inicializarPerfilPrueba(id, foto, nombre, arroba) {
      fotoPerfil.src = foto;
      nombreUsuario.textContent = nombre;
      usuarioArroba.textContent = arroba;
      rolUsuario.textContent = "Perfil de prueba AfinIA";

      fetch(`${API_BASE}/parametros?userId=${id}`).then(r=>r.json()).then(data=>{
        if (Object.keys(data).length === 0) {
          const parametrosVacios = {
            "Nivel AfinIA": 0, "Inteligencia": 0, "Simpat칤a": 0, "Comunicaci칩n": 0,
            "Carisma": 0, "Creatividad": 0, "Resoluci칩n de conflictos": 0,
            "Iniciativa": 0, "Organizaci칩n": 0, "Impulso personal": 0
          };
          fetch(`${API_BASE}/guardar-parametros`, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ userId:id, parametros:parametrosVacios })
          });
        }
      });

      alert(`游눫 춰Hola ${nombre}! Bienvenid@ a tu perfil de prueba en AfinIA 游꺚. Aqu칤 podr치s charlar conmigo, descubrir tus par치metros y ver c칩mo evolucionan.`);
    }

    if (USER_ID === "carolina") inicializarPerfilPrueba("carolina", "carolina.jpg", "Carolina", "@carolina");
    if (USER_ID === "hugo") inicializarPerfilPrueba("hugo", "hugo.jpg", "Hugo", "@hugo");
    if (USER_ID === "tania") inicializarPerfilPrueba("tania", "tania.jpg", "Tania", "@tania");
    if (USER_ID === "caco") inicializarPerfilPrueba("caco", "caco.jpg", "Caco", "@caco");

    // ====== Carga de par치metros del usuario ======
    async function cargarParametrosDesdeAPI() {
      try {
        const response = await fetch(`${API_BASE}/parametros?userId=${encodeURIComponent(USER_ID)}`, { cache: "no-store" });
        if (!response.ok) throw new Error("Backend no responde");
        const datos = await response.json();

        const sinNivel = Object.entries(datos).filter(([k]) => k !== "Nivel AfinIA");
        const top4 = sinNivel.sort((a, b) => b[1] - a[1]).slice(0, 4);

        const colores = {
          "Inteligencia": "verde",
          "Simpat칤a": "rojo",
          "Comunicaci칩n": "azul",
          "Carisma": "dorado",
          "Creatividad": "lavanda",
          "Resoluci칩n de conflictos": "coral",
          "Iniciativa": "oliva",
          "Organizaci칩n": "lila",
          "Impulso personal": "amarillo"
        };

        const contenedor = document.querySelector('.parametros');
        contenedor.innerHTML = '';

        top4.forEach(([nombre, valor]) => {
          const clase = colores[nombre] || 'gris';
          contenedor.innerHTML += `
            <div class="parametro">
              <span class="nombre-parametro">${nombre}</span>
              <div class="barra-base">
                <div class="barra ${clase}" style="width:${Number(valor)||0}%"></div>
              </div>
              <span class="porcentaje-out">${Number(valor)||0}%</span>
            </div>
          `;
        });

        if (top4.length) {
          const claseTop = colores[top4[0][0]];
          const foto = document.querySelector('.foto-perfil');
          foto.className = `foto-perfil borde-${claseTop}`;
        }
      } catch (err) {
        console.error("Error cargando par치metros:", err);
      }
    }

    // ====== Actualizaci칩n autom치tica de par치metros ======
    setInterval(cargarParametrosDesdeAPI, 5000); // cada 5 segundos

    // ====== Galer칤a privada (localStorage) ======
    const claveFotos = (u => `fotosPerfil_${u}`)(USER_ID);
    function cargarFoto(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = input.parentElement.querySelector('img');
          img.src = e.target.result;
          img.style.opacity = 1;
          guardarFotos();
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
    function guardarFotos() {
      const fotos = Array.from(document.querySelectorAll('.galeria-privada label img')).map(img => img.src);
      localStorage.setItem(claveFotos, JSON.stringify(fotos));
    }
    function cargarFotosGuardadas() {
      const fotosGuardadas = JSON.parse(localStorage.getItem(claveFotos) || "null");
      if (fotosGuardadas) {
        const imagenes = document.querySelectorAll('.galeria-privada label img');
        fotosGuardadas.forEach((src, i) => {
          if (imagenes[i]) {
            imagenes[i].src = src;
            imagenes[i].style.opacity = 1;
          }
        });
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      cargarParametrosDesdeAPI();
      cargarFotosGuardadas();
    });
  </script>
</body>
</html>
